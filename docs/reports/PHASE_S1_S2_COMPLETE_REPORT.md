# Phase S1 & S2 å®Œæˆå ±å‘Š

## âœ… Phase S1: Prisma â†’ Supabase SDK é·ç§»

### å·²é·ç§»çš„ API è·¯ç”±

1. **`/api/search`** âœ…
   - åŠŸèƒ½ï¼šæœå°‹é…’æ¬¾å’Œé…’èŠ
   - é·ç§»ï¼šä½¿ç”¨ Supabase SDK çš„ `or()` å’Œ `ilike` é€²è¡Œæ¨¡ç³Šæœå°‹
   - æ³¨æ„ï¼š`grapeVarieties` é™£åˆ—æœå°‹æš«æ™‚ç°¡åŒ–ï¼ˆä¸åŒ…å«åœ¨æœå°‹æ¢ä»¶ä¸­ï¼‰

2. **`/api/articles`** âœ…
   - åŠŸèƒ½ï¼šç²å–æ–‡ç« åˆ—è¡¨
   - é·ç§»ï¼šä½¿ç”¨ Supabase SDK æŸ¥è©¢ `articles` è¡¨
   - æ³¨æ„ï¼š`tags` é™£åˆ—æœå°‹æš«æ™‚ç°¡åŒ–ï¼ˆä¸åŒ…å«åœ¨æœå°‹æ¢ä»¶ä¸­ï¼‰

3. **`/api/contact`** âœ…
   - åŠŸèƒ½ï¼šè™•ç†è¯çµ¡è¡¨å–®æäº¤
   - é·ç§»ï¼šä½¿ç”¨ Supabase SDK çš„ `insert()` æ’å…¥ `inquiries` è¡¨

4. **`/api/cart`** âœ…
   - åŠŸèƒ½ï¼šç²å–ã€æ·»åŠ ã€æ¸…ç©ºè³¼ç‰©è»Š
   - é·ç§»ï¼šä½¿ç”¨ Supabase SDK æŸ¥è©¢ `carts` å’Œ `cart_items` è¡¨
   - æ³¨æ„ï¼šä½¿ç”¨åµŒå¥—æŸ¥è©¢ç²å–é…’æ¬¾å’Œé…’èŠè³‡è¨Š

5. **`/api/cart/[wineId]`** âœ…
   - åŠŸèƒ½ï¼šæ›´æ–°ã€ç§»é™¤è³¼ç‰©è»Šé …ç›®
   - é·ç§»ï¼šä½¿ç”¨ Supabase SDK çš„ `update()` å’Œ `delete()`

6. **`/api/wishlist`** âœ…
   - åŠŸèƒ½ï¼šç²å–ã€æ·»åŠ é¡˜æœ›æ¸…å–®
   - é·ç§»ï¼šä½¿ç”¨ Supabase SDK æŸ¥è©¢ `wishlists` å’Œ `wishlist_items` è¡¨

7. **`/api/wishlist/[wineId]`** âœ…
   - åŠŸèƒ½ï¼šç§»é™¤é¡˜æœ›æ¸…å–®é …ç›®
   - é·ç§»ï¼šä½¿ç”¨ Supabase SDK çš„ `delete()`

8. **`/api/user/me`** âœ…
   - åŠŸèƒ½ï¼šç²å–ã€æ›´æ–°ç”¨æˆ¶è³‡è¨Š
   - é·ç§»ï¼šä½¿ç”¨ Supabase SDK æŸ¥è©¢å’Œæ›´æ–° `users` è¡¨

9. **`/api/returns`** âœ…
   - åŠŸèƒ½ï¼šè™•ç†é€€æ›è²¨ç”³è«‹
   - é·ç§»ï¼šä½¿ç”¨ Supabase SDK æŸ¥è©¢ `orders` å’Œæ’å…¥ `inquiries` è¡¨

### æš«æ™‚ç°¡åŒ–çš„é‚è¼¯

1. **é™£åˆ—æ¬„ä½æœå°‹**
   - `grapeVarieties`ï¼ˆé…’æ¬¾ï¼‰ï¼šæš«æ™‚ä¸åŒ…å«åœ¨æœå°‹æ¢ä»¶ä¸­
   - `tags`ï¼ˆæ–‡ç« ï¼‰ï¼šæš«æ™‚ä¸åŒ…å«åœ¨æœå°‹æ¢ä»¶ä¸­
   - åŸå› ï¼šSupabase çš„é™£åˆ—æœå°‹éœ€è¦ä½¿ç”¨ `cs` æ“ä½œç¬¦ï¼Œéœ€è¦é¡å¤–è™•ç†

2. **é…’èŠé…’æ¬¾æ•¸é‡**
   - `/api/wineries`ï¼šæš«æ™‚è¨­ç‚º 0ï¼Œé¿å… N+1 æŸ¥è©¢å•é¡Œ
   - åŸå› ï¼šæ‰¹é‡æŸ¥è©¢æœƒå¢åŠ æŸ¥è©¢æ™‚é–“ï¼Œå½±éŸ¿é¦–é è¼‰å…¥é€Ÿåº¦

## âœ… Phase S2: Prisma æ¸…ç†èˆ‡é©—è­‰

### å·²ç§»é™¤çš„å…§å®¹

1. **package.json**
   - âœ… ç§»é™¤ `@prisma/client` ä¾è³´
   - âœ… ç§»é™¤ `prisma` ä¾è³´
   - âœ… ç§»é™¤ Prisma ç›¸é—œ scriptsï¼š
     - `db:generate`
     - `db:push`
     - `db:migrate`
     - `db:studio`

2. **æª”æ¡ˆ**
   - âœ… åˆªé™¤ `lib/prisma.ts`
   - âœ… åˆªé™¤ `lib/supabase/direct-queries.ts`ï¼ˆä¸å†éœ€è¦ï¼‰

3. **ä¿ç•™çš„æª”æ¡ˆ**
   - âš ï¸ `prisma/schema.prisma` - ä¿ç•™ä½œç‚ºè³‡æ–™åº«çµæ§‹åƒè€ƒï¼ˆå¯æ‰‹å‹•åˆªé™¤ï¼‰

### é©—è­‰çµæœ

- âœ… æ‰€æœ‰ API è·¯ç”±å·²é·ç§»åˆ° Supabase SDK
- âœ… æ²’æœ‰ç™¼ç¾ä»»ä½• Prisma å¼•ç”¨ï¼ˆé™¤äº† schema.prismaï¼‰
- âœ… TypeScript ç·¨è­¯é€šé
- âœ… API æ¸¬è©¦æˆåŠŸ

## ğŸ”§ å¿«å–å’Œæ€§èƒ½å„ªåŒ–

### å·²å®Œæˆçš„å„ªåŒ–

1. **å¼·åˆ¶ç¦ç”¨å¿«å–**
   - âœ… `middleware.ts` - æ·»åŠ å¼·åˆ¶ Cache-Control æ¨™é ­
   - âœ… `next.config.js` - æ·»åŠ  headers é…ç½®
   - âœ… `app/page.tsx` - æ·»åŠ  `next: { revalidate: 0 }` å’Œå®Œæ•´ Cache-Control æ¨™é ­

2. **æŸ¥è©¢å„ªåŒ–**
   - âœ… `/api/wines` - åªé¸æ“‡éœ€è¦çš„æ¬„ä½ï¼ˆæ¸›å°‘æ•¸æ“šå‚³è¼¸ï¼‰
   - âœ… `/api/wineries` - åªé¸æ“‡éœ€è¦çš„æ¬„ä½
   - âœ… `/api/wineries` - ç§»é™¤ N+1 æŸ¥è©¢ï¼ˆæš«æ™‚è¨­ wineCount ç‚º 0ï¼‰

3. **è¶…æ™‚ä¿è­·**
   - âœ… `/api/wines` - æ·»åŠ  5 ç§’è¶…æ™‚ä¿è­·
   - âœ… `/api/wineries` - æ·»åŠ  5 ç§’è¶…æ™‚ä¿è­·

## ğŸ“Š ç•¶å‰è³‡æ–™å­˜å–å±¤è¨­è¨ˆ

### Supabase SDK ä½¿ç”¨æ–¹å¼

**æœå‹™ç«¯æŸ¥è©¢**:
```typescript
import { createServerSupabaseClient } from "@/lib/supabase/client";

const supabase = createServerSupabaseClient();
const { data, error } = await supabase
  .from("table_name")
  .select("*")
  .eq("field", "value");
```

**å®¢æˆ¶ç«¯æŸ¥è©¢**:
```typescript
import { createClient } from "@/lib/supabase/client";

const supabase = createClient();
const { data, error } = await supabase
  .from("table_name")
  .select("*");
```

### å„ªé»

1. âœ… çµ±ä¸€çš„è³‡æ–™å­˜å–æ–¹å¼ï¼ˆåªä½¿ç”¨ Supabase SDKï¼‰
2. âœ… æ›´ç°¡å–®çš„æŸ¥è©¢èªæ³•
3. âœ… å…§å»º RLS (Row Level Security) æ”¯æ´
4. âœ… æ›´å¥½çš„éŒ¯èª¤è™•ç†
5. âœ… æ›´å¿«çš„æŸ¥è©¢é€Ÿåº¦ï¼ˆç›´æ¥ä½¿ç”¨ Supabase APIï¼‰

### é™åˆ¶

1. âš ï¸ é™£åˆ—æ¬„ä½æœå°‹éœ€è¦é¡å¤–è™•ç†ï¼ˆ`cs` æ“ä½œç¬¦ï¼‰
2. âš ï¸ è¤‡é›œçš„ JOIN æŸ¥è©¢éœ€è¦ä½¿ç”¨åµŒå¥— `select()`
3. âš ï¸ éœ€è¦ç¢ºä¿ RLS æ”¿ç­–æ­£ç¢ºé…ç½®

### æœªä¾†æ³¨æ„äº‹é …

å¦‚æœæœªä¾†éœ€è¦é‡æ–°å°å…¥ Prismaï¼š
1. ç¢ºä¿å–®ä¸€ migration sourceï¼ˆä¸è¦åŒæ™‚ä½¿ç”¨ Prisma å’Œ Supabase migrationsï¼‰
2. é¿å…é›™è»Œ schemaï¼ˆåªä½¿ç”¨ä¸€å€‹ schema å®šç¾©ä¾†æºï¼‰
3. è€ƒæ…®ä½¿ç”¨ Supabase çš„ Migration å·¥å…·è€Œä¸æ˜¯ Prisma

## ğŸ¯ æ¸¬è©¦å»ºè­°

1. **æ¸¬è©¦æ‰€æœ‰é é¢**
   - é¦–é ï¼šæ‡‰è©²å¿«é€Ÿè¼‰å…¥ï¼ˆ< 3 ç§’ï¼‰
   - é…’å“ä»‹ç´¹ï¼šæ‡‰è©²é¡¯ç¤ºæ‰€æœ‰é…’æ¬¾
   - é…’èŠæ•…äº‹ï¼šæ‡‰è©²é¡¯ç¤ºæ‰€æœ‰é…’èŠ
   - æœå°‹åŠŸèƒ½ï¼šæ‡‰è©²æ­£å¸¸é‹ä½œ
   - è³¼ç‰©è»Š/é¡˜æœ›æ¸…å–®ï¼šæ‡‰è©²æ­£å¸¸é‹ä½œ

2. **æª¢æŸ¥çµ‚ç«¯æ—¥èªŒ**
   - ä¸æ‡‰è©²æœ‰ Prisma ç›¸é—œéŒ¯èª¤
   - ä¸æ‡‰è©²æœ‰ 500 éŒ¯èª¤
   - Supabase æŸ¥è©¢æ‡‰è©²æˆåŠŸ

3. **æ¸…é™¤ç€è¦½å™¨å¿«å–**
   - æŒ‰ F12 æ‰“é–‹é–‹ç™¼è€…å·¥å…·
   - å³éµé»æ“Šåˆ·æ–°æŒ‰éˆ•
   - é¸æ“‡ã€Œæ¸…é™¤å¿«å–ä¸¦å¼·åˆ¶é‡æ–°è¼‰å…¥ã€

## âœ… å®Œæˆç‹€æ…‹

- âœ… Phase S0: Prisma ä½¿ç”¨æƒ…æ³å¯©æŸ¥
- âœ… Phase S1: Prisma â†’ Supabase SDK é·ç§»
- âœ… Phase S2: Prisma æ¸…ç†èˆ‡é©—è­‰
- âœ… å¿«å–å•é¡Œä¿®å¾©
- âœ… æ€§èƒ½å„ªåŒ–ï¼ˆæ¸›å°‘æŸ¥è©¢æ¬„ä½ï¼Œé¿å… N+1ï¼‰

å°ˆæ¡ˆç¾åœ¨å®Œå…¨ä½¿ç”¨ Supabase SDK é€²è¡Œè³‡æ–™åº«æŸ¥è©¢ï¼Œä¸å†ä¾è³´ Prismaã€‚

