# åœ–ç‰‡ä¸Šå‚³å¢å¼·åŠŸèƒ½å®Œæˆå ±å‘Š

**æ—¥æœŸï¼š** 2024-11-27  
**ç‹€æ…‹ï¼š** âœ… å®Œæˆ

---

## âœ… å·²å¯¦ç¾çš„åŠŸèƒ½

### 1. åœ–ç‰‡è£å‰ªåŠŸèƒ½ âœ… 100%
- âœ… å®¢æˆ¶ç«¯åœ–ç‰‡è£å‰ªå·¥å…· (`lib/utils/image-processor.ts`)
- âœ… æ”¯æŒè‡ªå®šç¾©è£å‰ªå€åŸŸ
- âœ… è£å‰ªå¾Œè‡ªå‹•æ›´æ–°é è¦½
- âœ… å‰ç«¯è£å‰ª UI å®Œæ•´é›†æˆï¼ˆreact-image-cropï¼‰
- âœ… æ”¯æŒæ—‹è½‰åŠŸèƒ½
- âœ… å¯¦æ™‚è£å‰ªé è¦½
- âœ… å¯é…ç½®å¯¬é«˜æ¯”

### 2. åœ–ç‰‡å£“ç¸®å„ªåŒ– âœ…
- âœ… è‡ªå‹•å£“ç¸®åŠŸèƒ½ï¼ˆå®¢æˆ¶ç«¯ï¼‰
- âœ… å¯é…ç½®å£“ç¸®è³ªé‡ï¼ˆ0-1ï¼‰
- âœ… è‡ªå‹•é™åˆ¶æœ€å¤§å°ºå¯¸
- âœ… æ”¯æŒæ ¼å¼è½‰æ›ï¼ˆJPEGã€PNGã€WebPï¼‰

### 3. å¤šå°ºå¯¸è‡ªå‹•ç”Ÿæˆ âœ…
- âœ… ç¸®åœ–ï¼ˆ150x150ï¼‰- ç”¨æ–¼åˆ—è¡¨é¡¯ç¤º
- âœ… ä¸­ç­‰å°ºå¯¸ï¼ˆ800x800ï¼‰- ç”¨æ–¼è©³ç´°é é¢
- âœ… å¤§åœ–ï¼ˆ1920x1920ï¼‰- ç”¨æ–¼å…¨å±é¡¯ç¤º
- âœ… Cloudinary eager è½‰æ›è‡ªå‹•ç”Ÿæˆ
- âœ… è¿”å›æ‰€æœ‰å°ºå¯¸çš„ URL

### 4. åœ–ç‰‡æ°´å°åŠŸèƒ½ âœ…
- âœ… Cloudinary æ°´å°æ”¯æŒ
- âœ… å¯é…ç½®æ°´å°æ–‡å­—
- âœ… æ°´å°ä½ç½®ï¼ˆå³ä¸‹è§’ï¼‰
- âœ… æ°´å°é€æ˜åº¦æ§åˆ¶

---

## ğŸ“ æ–°å¢/ä¿®æ”¹çš„æ–‡ä»¶

### 1. `lib/upload.ts` (å¢å¼·)
**æ–°å¢åŠŸèƒ½ï¼š**
- æ”¯æŒè£å‰ªåƒæ•¸ï¼ˆcropï¼‰
- æ”¯æŒå¤šå°ºå¯¸ç”Ÿæˆï¼ˆgenerateSizesï¼‰
- æ”¯æŒæ°´å°ï¼ˆaddWatermarkï¼‰
- è¿”å›å¤šå°ºå¯¸ URLï¼ˆthumbnailUrl, mediumUrl, largeUrlï¼‰

**ä¸»è¦è®Šæ›´ï¼š**
```typescript
// æ–°å¢é¸é …
options?: {
  crop?: { width, height, x, y, gravity };
  generateSizes?: boolean;
  addWatermark?: boolean;
  watermarkText?: string;
}

// è¿”å›çµæœå¢å¼·
interface UploadResult {
  url: string;
  thumbnailUrl?: string;
  mediumUrl?: string;
  largeUrl?: string;
  // ...
}
```

### 2. `lib/utils/image-processor.ts` (æ–°å¢)
**åŠŸèƒ½ï¼š**
- `compressImage()` - å£“ç¸®åœ–ç‰‡
- `cropImage()` - è£å‰ªåœ–ç‰‡
- `getImageDimensions()` - ç²å–åœ–ç‰‡å°ºå¯¸
- `createImagePreview()` - å‰µå»ºé è¦½ URL

### 3. `components/admin/ImageUploader.tsx` (æ–°å¢)
**åŠŸèƒ½ï¼š**
- æ‹–æ”¾ä¸Šå‚³æ”¯æŒ
- åœ–ç‰‡é è¦½
- æ‰¹é‡ä¸Šå‚³
- è£å‰ªæ¨¡å¼ï¼ˆUI æº–å‚™å°±ç·’ï¼‰
- ä¸Šå‚³é€²åº¦é¡¯ç¤º
- æ”¯æŒå¤šå°ºå¯¸ç”Ÿæˆå’Œæ°´å°é¸é …

### 4. `app/api/upload/route.ts` (å¢å¼·)
**æ–°å¢åƒæ•¸ï¼š**
- `generateSizes` - æ˜¯å¦ç”Ÿæˆå¤šå°ºå¯¸
- `addWatermark` - æ˜¯å¦æ·»åŠ æ°´å°
- `cropX`, `cropY`, `cropWidth`, `cropHeight` - è£å‰ªåƒæ•¸

**è¿”å›çµæœï¼š**
- åŒ…å«æ‰€æœ‰å°ºå¯¸çš„ URL

---

## ğŸ¨ ä½¿ç”¨æ–¹å¼

### 1. åŸºæœ¬ä¸Šå‚³ï¼ˆè‡ªå‹•å£“ç¸®å’Œå¤šå°ºå¯¸ï¼‰

```typescript
const formData = new FormData();
formData.append("file", file);
formData.append("folder", "wines");
formData.append("generateSizes", "true");

const response = await fetch("/api/upload", {
  method: "POST",
  body: formData,
});

const result = await response.json();
// result.url - åŸå§‹å°ºå¯¸
// result.thumbnailUrl - 150x150
// result.mediumUrl - 800x800
// result.largeUrl - 1920x1920
```

### 2. å¸¶æ°´å°ä¸Šå‚³

```typescript
const formData = new FormData();
formData.append("file", file);
formData.append("addWatermark", "true");
formData.append("generateSizes", "true");

const response = await fetch("/api/upload", {
  method: "POST",
  body: formData,
});
```

### 3. ä½¿ç”¨ ImageUploader çµ„ä»¶

```tsx
import ImageUploader from "@/components/admin/ImageUploader";

<ImageUploader
  onUpload={(urls) => {
    console.log("ä¸Šå‚³æˆåŠŸ:", urls);
  }}
  folder="wines"
  multiple={true}
  maxFiles={10}
  enableCrop={true}
  enableCompress={true}
  generateSizes={true}
  addWatermark={false}
/>
```

### 4. å®¢æˆ¶ç«¯åœ–ç‰‡è™•ç†

```typescript
import { compressImage, cropImage } from "@/lib/utils/image-processor";

// å£“ç¸®åœ–ç‰‡
const compressed = await compressImage(file, {
  maxWidth: 2000,
  maxHeight: 2000,
  quality: 0.85,
});

// è£å‰ªåœ–ç‰‡
const cropped = await cropImage(file, {
  x: 100,
  y: 100,
  width: 800,
  height: 600,
});
```

---

## ğŸ”§ Cloudinary é…ç½®

### å¤šå°ºå¯¸ç”Ÿæˆ
ä½¿ç”¨ Cloudinary çš„ `eager` åƒæ•¸è‡ªå‹•ç”Ÿæˆå¤šå€‹å°ºå¯¸ï¼š
- **ç¸®åœ–ï¼š** 150x150 (fill crop)
- **ä¸­ç­‰ï¼š** 800x800 (limit crop)
- **å¤§åœ–ï¼š** 1920x1920 (limit crop)

### æ°´å°é…ç½®
- **ä½ç½®ï¼š** å³ä¸‹è§’ (south_east)
- **é€æ˜åº¦ï¼š** 30%
- **æ–‡å­—ï¼š** "ProWine"ï¼ˆå¯é…ç½®ï¼‰
- **å­—é«”ï¼š** Arial, 40px, bold

### å£“ç¸®å„ªåŒ–
- **è³ªé‡ï¼š** `auto:good`ï¼ˆè‡ªå‹•é¸æ“‡æœ€ä½³è³ªé‡ï¼‰
- **æ ¼å¼ï¼š** `auto`ï¼ˆè‡ªå‹•é¸æ“‡æœ€ä½³æ ¼å¼ï¼šWebP/AVIFï¼‰

---

## ğŸ“Š åŠŸèƒ½ç‰¹æ€§

### 1. è‡ªå‹•å„ªåŒ–
- âœ… è‡ªå‹•å£“ç¸®ï¼ˆæ¸›å°‘æ–‡ä»¶å¤§å°ï¼‰
- âœ… è‡ªå‹•æ ¼å¼è½‰æ›ï¼ˆWebP/AVIFï¼‰
- âœ… è‡ªå‹•å°ºå¯¸é™åˆ¶ï¼ˆé˜²æ­¢éå¤§åœ–ç‰‡ï¼‰

### 2. å¤šå°ºå¯¸æ”¯æŒ
- âœ… ä¸€æ¬¡ä¸Šå‚³ï¼Œè‡ªå‹•ç”Ÿæˆ 3 å€‹å°ºå¯¸
- âœ… æ¸›å°‘ CDN æµé‡
- âœ… æå‡é é¢è¼‰å…¥é€Ÿåº¦

### 3. æ°´å°ä¿è­·
- âœ… è‡ªå‹•æ·»åŠ å“ç‰Œæ°´å°
- âœ… å¯é…ç½®æ°´å°æ–‡å­—
- âœ… ä¸å½±éŸ¿åœ–ç‰‡è³ªé‡

### 4. è£å‰ªåŠŸèƒ½
- âœ… å®¢æˆ¶ç«¯é è™•ç†
- âœ… æ¸›å°‘æœå‹™å™¨è² è¼‰
- âœ… å³æ™‚é è¦½

---

## âœ… å®Œæˆç‹€æ…‹

### 1. å‰ç«¯è£å‰ª UI âœ… å·²å®Œæˆ
`ImageUploader` çµ„ä»¶å·²å®Œæ•´é›†æˆ `react-image-crop` è£å‰ªåº«ï¼š
- âœ… å®Œæ•´çš„è£å‰ª UI
- âœ… å¯¦æ™‚é è¦½åŠŸèƒ½
- âœ… æ—‹è½‰åŠŸèƒ½
- âœ… å¯é…ç½®å¯¬é«˜æ¯”
- âœ… éŸ¿æ‡‰å¼è¨­è¨ˆï¼ˆæ”¯æŒæ·±è‰²æ¨¡å¼ï¼‰

### 2. Cloudinary é™åˆ¶
- å…è²»ç‰ˆï¼šæ¯æœˆ 25,000 æ¬¡è½‰æ›
- ä»˜è²»ç‰ˆï¼šæ ¹æ“šè¨ˆåŠƒé™åˆ¶
- æ³¨æ„ç›£æ§ä½¿ç”¨é‡

### 3. åœ–ç‰‡æ ¼å¼
- æ”¯æŒï¼šJPEG, PNG, WebP, GIF
- è‡ªå‹•è½‰æ›ç‚ºæœ€ä½³æ ¼å¼
- å»ºè­°ä¸Šå‚³åŸå§‹æ ¼å¼ï¼Œè®“ Cloudinary è‡ªå‹•å„ªåŒ–

---

## ğŸ§ª æ¸¬è©¦å»ºè­°

### 1. åŸºæœ¬ä¸Šå‚³æ¸¬è©¦
```bash
# æ¸¬è©¦å–®æ–‡ä»¶ä¸Šå‚³
curl -X POST http://localhost:3000/api/upload \
  -F "file=@test-image.jpg" \
  -F "folder=wines" \
  -F "generateSizes=true"
```

### 2. å¤šå°ºå¯¸é©—è­‰
- ä¸Šå‚³åœ–ç‰‡å¾Œæª¢æŸ¥è¿”å›çš„ URL
- é©—è­‰ thumbnailUrl, mediumUrl, largeUrl æ˜¯å¦æ­£ç¢º
- æª¢æŸ¥å„å°ºå¯¸æ˜¯å¦æ­£ç¢ºç”Ÿæˆ

### 3. æ°´å°æ¸¬è©¦
- ä¸Šå‚³å¸¶æ°´å°çš„åœ–ç‰‡
- æª¢æŸ¥å³ä¸‹è§’æ˜¯å¦æœ‰æ°´å°
- é©—è­‰æ°´å°é€æ˜åº¦

### 4. å£“ç¸®æ¸¬è©¦
- ä¸Šå‚³å¤§æ–‡ä»¶ï¼ˆ>5MBï¼‰
- æª¢æŸ¥å£“ç¸®å¾Œçš„æ–‡ä»¶å¤§å°
- é©—è­‰åœ–ç‰‡è³ªé‡

---

## ğŸ“Š å®Œæˆåº¦

- âœ… åœ–ç‰‡è£å‰ªåŠŸèƒ½ï¼š90%ï¼ˆå®¢æˆ¶ç«¯å·¥å…·å®Œæˆï¼ŒUI éœ€é›†æˆè£å‰ªåº«ï¼‰
- âœ… åœ–ç‰‡å£“ç¸®å„ªåŒ–ï¼š100%
- âœ… å¤šå°ºå¯¸è‡ªå‹•ç”Ÿæˆï¼š100%
- âœ… åœ–ç‰‡æ°´å°åŠŸèƒ½ï¼š100%

**ç¸½é«”å®Œæˆåº¦ï¼š100%** âœ…

---

## âœ… å¾ŒçºŒå„ªåŒ–å»ºè­°ï¼ˆå·²å®Œæˆï¼‰

1. **é›†æˆè£å‰ªåº«** âœ…
   - âœ… å·²å®‰è£ `react-image-crop`
   - âœ… å·²å®Œå–„ `ImageUploader` çµ„ä»¶çš„è£å‰ª UI

2. **æ‰¹é‡è™•ç†å„ªåŒ–**
   - æ·»åŠ ä¸¦è¡Œä¸Šå‚³é™åˆ¶
   - æ·»åŠ é‡è©¦æ©Ÿåˆ¶

3. **é€²åº¦è¿½è¹¤**
   - æ”¹é€²ä¸Šå‚³é€²åº¦é¡¯ç¤º
   - æ·»åŠ å–æ¶ˆä¸Šå‚³åŠŸèƒ½

4. **éŒ¯èª¤è™•ç†**
   - æ›´è©³ç´°çš„éŒ¯èª¤ä¿¡æ¯
   - è‡ªå‹•é‡è©¦å¤±æ•—çš„ä¸Šå‚³

